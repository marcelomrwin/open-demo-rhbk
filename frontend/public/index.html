<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Red Hat Build of Keycloak Application Example</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  </head>
  <body class="container">
    <div style="padding-left: 5px; padding-top: 5px; padding-bottom: 5px; background-color: #151515;">
      <img src="logo.svg"/>
      <h2 id="greeting" style="color: white;"></h2>
    </div>
    <div id="user" style="display: none; padding-top: 5px;">
      <button class="btn btn-danger" id="logout" type="button">Logout</button>
      <button class="btn btn-primary" id="showMyAccount" type="button">My Account</button>
      <button class="btn btn-primary" id="showIdToken" type="button">Show ID Token</button>
      <button class="btn btn-primary" id="showAccessToken" type="button">Show Access Token</button>
      <button class="btn btn-primary" id="refreshToken" type="button">Refresh</button>
      <button class="btn btn-primary" id="unprotectedMethod" type="button"><span class="bi-unlock"></span>&nbsp;Unprotected Method</button>
      <button class="btn btn-primary" id="protectedMethod" type="button"><span class="bi-lock"></span>&nbsp;Protected Method</button>
      <button class="btn btn-primary" id="chainMethod" type="button"><span class="bi-link"></span>&nbsp;Chain Method</button>
      <hr>
      <h3 id="name"></h3>
      <pre id="output"></pre>
    </div>
    <script type="module" src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="KC_URL/js/keycloak.js"></script>
    <script type="module">

      const outputElement = document.getElementById("output");
      const nameElement = document.getElementById("name");
      const userElement = document.getElementById("user");
      const titleElement = document.getElementById("greeting");

      function output(content) {
        if (typeof content === "object") {
          content = JSON.stringify(content, null, 2);
        }

        outputElement.textContent = content;
      }

      function showProfile() {
        const name =
          keycloak.idTokenParsed.name ||
          keycloak.idTokenParsed.preferred_username;

        nameElement.textContent = `Hello ${name}`;
        userElement.style.display = "block";
      }

      document.getElementById("logout").addEventListener("click", () => {
        keycloak.logout();
      });

      document.getElementById("showIdToken").addEventListener("click", () => {
        output(keycloak.idTokenParsed);
      });

      document
        .getElementById("showAccessToken")
        .addEventListener("click", () => {
          output(keycloak.tokenParsed);
        });

      document
        .getElementById("refreshToken")
        .addEventListener("click", async () => {
          await keycloak.updateToken(-1);
          output(keycloak.idTokenParsed);
          showProfile();
        });

      document
        .getElementById("showMyAccount")
        .addEventListener("click", async () => {
          await keycloak.accountManagement()
        });

      document.getElementById("unprotectedMethod")
        .addEventListener("click", async () => {
          try{
            const response = await fetch("REST_API",{method:"GET"});
            const data = await response.text();
            output(data);
          }catch(error){
            output(error);
          }
        });

      document.getElementById("protectedMethod")
      .addEventListener("click", async () => {
        
          fetch("REST_API/protected",{headers: {Authorization: 'Bearer '+keycloak.token}})
            .then(resp => resp.text())
            .then(text => output(text))
            .catch(error => console.error(error));
      });

      document.getElementById("chainMethod")
      .addEventListener("click", async () => {
          fetch("REST_API/chain",{headers: {Authorization: 'Bearer '+keycloak.token}})
            .then(resp => resp.text())
            .then(text => output(text))
            .catch(error => console.error(error));
      });

      const keycloak = new Keycloak();
      await keycloak.init({ onLoad: "login-required" });
      titleElement.textContent = "I'm the frontend for a APP_NAME Application";
      showProfile();
    </script>
  </body>
</html>